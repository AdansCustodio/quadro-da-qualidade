<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Qualidade - CCO Fornos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-size: 1.1rem; }
        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid black; text-align: center; padding: 2px; }
        .header-blue { color: #2563eb; }
        .bg-gray-custom { background-color: #f3f4f6; }
        input, select { width: 100%; height: 100%; border: none; background: transparent; text-align: center; outline: none; font-size: 1rem; appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .defect-input { width: 100%; border-bottom: 1px solid #ccc; padding: 1px 4px; text-align: left; font-size: 0.85rem; height: 1.4rem; }
        .defect-input:last-child { border-bottom: none; }
        .defect-input:focus { background-color: #fffde7; }
        .text-target-ok { color: #16a34a; font-weight: bold; }
        .text-target-low { color: #dc2626; font-weight: bold; }
        .shift-stamp { display: block; font-size: 0.55rem; color: #6b7280; line-height: 1; margin-top: 1px; text-transform: uppercase; }
        .tab-btn { transition: all 0.2s; border-bottom: 4px solid transparent; }
        .tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; background-color: #eff6ff; }
        .btn-presentation { background-color: #f59e0b; color: white; border-radius: 4px; }
        .btn-general { background-color: #1e293b; color: white; border-radius: 4px; }
        .btn-config { background-color: #4b5563; color: white; border-radius: 4px; }
        .btn-config.active { background-color: #374151; ring: 2px solid #9ca3af; }
        .btn-nav-date { background-color: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; }
        .btn-nav-date:hover { background-color: #e5e7eb; }
        .quebra-total-box { width: 60px; border-left: 1px solid #999; display: flex; flex-direction: column; background-color: #fafafa; }
        .quebra-total-header { font-size: 0.5rem; font-weight: bold; border-bottom: 1px solid #999; padding: 1px 0; background-color: #f0f0f0; color: #444; }
        #presentation-overlay { display: none; position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.85); color: white; padding: 15px 25px; border-radius: 8px; z-index: 1000; border-left: 5px solid #f59e0b; }
        
        .grid-view-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 10px; max-width: 100% !important; }
        @media (min-width: 1600px) { .grid-view-container { grid-template-columns: repeat(3, 1fr); } }
        .oven-card { background: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid #000; }
        
        /* Estilos da Aba de Configuração */
        .config-container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 500px; margin: 20px auto; border: 1px solid #e5e7eb; }

        /* Modal de Senha */
        #password-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; }
        .pwd-content { background: white; padding: 25px; border-radius: 8px; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
    </style>
</head>
<body class="bg-gray-200 p-4">

    <!-- Navegação Superior -->
    <div class="max-w-[98%] mx-auto mb-4 flex space-x-1 bg-white p-1 shadow-sm rounded-t-lg border-b overflow-x-auto items-center">
        <button onclick="window.setViewMode('single', 'FORNO 1')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 active whitespace-nowrap" id="btn-FORNO 1">Forno 1</button>
        <button onclick="window.setViewMode('single', 'FORNO 2')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 whitespace-nowrap" id="btn-FORNO 2">Forno 2</button>
        <button onclick="window.setViewMode('single', 'FORNO 3A')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 whitespace-nowrap" id="btn-FORNO 3A">Forno 3A</button>
        <button onclick="window.setViewMode('single', 'FORNO 3B')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 whitespace-nowrap" id="btn-FORNO 3B">Forno 3B</button>
        <button onclick="window.setViewMode('single', 'FORNO 4')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 whitespace-nowrap" id="btn-FORNO 4">Forno 4</button>
        <button onclick="window.setViewMode('single', 'RETÍFICA 1')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 whitespace-nowrap" id="btn-RETÍFICA 1">Retífica 1</button>
        <button onclick="window.setViewMode('single', 'RETÍFICA 2')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 whitespace-nowrap" id="btn-RETÍFICA 2">Retífica 2</button>
        
        <div class="flex items-center px-4 space-x-2 border-l border-gray-300 ml-2">
            <button onclick="window.changeDate(-1)" class="btn-nav-date p-1" title="Dia Anterior">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <div class="flex flex-col items-center min-w-[100px]">
                <span class="text-[10px] uppercase font-bold text-gray-500">Data Registro</span>
                <span id="display-date" class="text-xs font-black text-blue-700">--/--/----</span>
            </div>
            <button onclick="window.changeDate(1)" class="btn-nav-date p-1" title="Próximo Dia">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
        </div>

        <div class="flex-grow"></div>

        <button onclick="window.setViewMode('grid')" class="btn-general px-4 py-2 font-bold uppercase text-xs shadow-sm flex items-center gap-2 whitespace-nowrap mr-2" id="btn-GERAL">
            GERAL
        </button>

        <button onclick="window.openPasswordModal()" class="btn-config px-3 py-2 shadow-sm flex items-center justify-center mr-2" id="btn-CONFIG" title="Configurações">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>

        <button onclick="window.togglePresentation()" class="btn-presentation px-4 py-2 font-bold uppercase text-xs shadow-sm flex items-center gap-2 whitespace-nowrap">
            Apresentação
        </button>
    </div>

    <!-- Modal de Senha -->
    <div id="password-modal">
        <div class="pwd-content">
            <h3 class="text-lg font-bold mb-4 text-gray-800">Acesso Restrito</h3>
            <p class="text-sm text-gray-600 mb-4">Digite a senha de administrador para acessar as configurações.</p>
            
            <input type="password" id="admin-password" class="w-full border-2 border-gray-300 rounded p-2 mb-4 text-center" placeholder="Senha">
            
            <div class="flex justify-between gap-2">
                <button onclick="window.closePasswordModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded font-bold text-sm">Cancelar</button>
                <button onclick="window.submitPassword()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-bold text-sm">Confirmar</button>
            </div>
            <p id="pwd-error" class="text-red-500 text-xs mt-2 hidden">Senha incorreta!</p>
        </div>
    </div>

    <div id="presentation-overlay">
        <div class="flex flex-col items-center">
            <span class="text-xs uppercase opacity-70 mb-1">Ciclo Ativo</span>
            <div class="flex items-center gap-4">
                <span class="font-bold">Troca em: <span id="presentation-timer">30</span>s</span>
                <button onclick="window.togglePresentation()" class="bg-red-600 hover:bg-red-700 text-white text-[10px] px-2 py-1 rounded font-bold uppercase">Sair</button>
            </div>
        </div>
    </div>

    <div id="main-content" class="max-w-7xl mx-auto"></div>

    <datalist id="ref-suggestions"></datalist>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // CONFIGURAÇÃO FIREBASE
        // ==========================================
        const githubFirebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : githubFirebaseConfig;
        
        // Diagnóstico de Configuração
        if (!firebaseConfig.apiKey) {
            console.error("ATENÇÃO: Chaves do Firebase não encontradas! O salvamento não funcionará.");
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Inicialização Segura
        let app, auth, db;
        try {
            if (firebaseConfig.apiKey) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase inicializado com sucesso.");
            } else {
                console.warn("Firebase não inicializado (falta configuração). Modo offline ativo (dados não serão salvos).");
            }
        } catch (e) {
            console.error("Erro crítico na inicialização do Firebase:", e);
        }

        // ==========================================
        // ESTADO GLOBAL
        // ==========================================
        const ovenList = ['FORNO 1', 'FORNO 2', 'FORNO 3A', 'FORNO 3B', 'FORNO 4', 'RETÍFICA 1', 'RETÍFICA 2'];
        const schedule = [
            { time: "21:30", shift: "TC" }, { time: "23:30", shift: "TC" }, 
            { time: "01:30", shift: "TC" }, { time: "03:30", shift: "TC" },
            { time: "05:30", shift: "TA" }, { time: "07:30", shift: "TA" }, 
            { time: "09:30", shift: "TA" }, { time: "11:30", shift: "TA" },
            { time: "13:30", shift: "TB" }, { time: "15:30", shift: "TB" }, 
            { time: "17:30", shift: "TB" }, { time: "19:30", shift: "TB" }
        ];

        let currentOven = 'FORNO 1';
        let viewMode = 'single';
        let selectedDate = new Date();
        let presentationInterval = null;
        let countdownInterval = null;
        let countdownSeconds = 30;
        let unsubscribeRealtime = null;
        
        let configTargets = { quality: 97.0, breakage: 1.5 };

        // Carregar config local
        try {
            const savedConfig = localStorage.getItem('cco_config_targets');
            if (savedConfig) configTargets = JSON.parse(savedConfig);
        } catch(e) { console.error("Erro localStorage:", e); }
        
        const saveTimeouts = {};
        const ovenDataStore = {};

        // ==========================================
        // FUNÇÕES AUXILIARES
        // ==========================================
        const resetStore = () => {
            ovenList.forEach(ov => {
                ovenDataStore[ov] = { 
                    linha: '', 
                    rows: Array(12).fill(null).map(() => ({ 
                        ref: '', turno: '', vol: '', qHora: '', 
                        defects: ['', '', '', ''], quebras: ['', '', '', ''] 
                    })) 
                };
            });
        };

        const getDateKey = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const updateDateUI = () => {
            const d = selectedDate.getDate().toString().padStart(2, '0');
            const m = (selectedDate.getMonth() + 1).toString().padStart(2, '0');
            const y = selectedDate.getFullYear();
            const display = document.getElementById('display-date');
            if(display) display.innerText = `${d}/${m}/${y}`;
        };

        // ==========================================
        // LÓGICA DE SALVAMENTO E SINCRONIZAÇÃO
        // ==========================================
        const saveToFirebase = (ovenId) => {
            if (!db) return; // Modo offline silencioso

            // Verifica se existe dado para salvar
            if (!ovenDataStore[ovenId]) {
                console.warn(`Tentativa de salvar dados inexistentes para ${ovenId}`);
                return;
            }

            if (saveTimeouts[ovenId]) clearTimeout(saveTimeouts[ovenId]);
            
            // Cópia de segurança
            const dataToSave = JSON.parse(JSON.stringify(ovenDataStore[ovenId]));
            const targetDateKey = getDateKey(selectedDate);
            
            saveTimeouts[ovenId] = setTimeout(async () => {
                try {
                    const docId = `${ovenId}_${targetDateKey}`;
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'records', docId);
                    await setDoc(docRef, dataToSave);
                    // console.log(`Dados salvos para ${ovenId}`);
                } catch (e) { 
                    console.error("Erro ao salvar no Firebase:", e); 
                }
            }, 1000);
        };

        const setupRealtimeListener = () => {
            if (unsubscribeRealtime) unsubscribeRealtime();
            if (!db) return;

            const dateKey = getDateKey(selectedDate);
            const ovensCollection = collection(db, 'artifacts', appId, 'public', 'data', 'records');
            
            unsubscribeRealtime = onSnapshot(ovensCollection, (snapshot) => {
                let hasData = false;
                snapshot.forEach((doc) => {
                    if (doc.id.includes(dateKey)) {
                        const ovenName = doc.id.replace(`_${dateKey}`, '');
                        if (ovenList.includes(ovenName)) {
                            ovenDataStore[ovenName] = doc.data();
                            hasData = true;
                        }
                    }
                });
                
                // Se o snapshot veio vazio (dia novo), resetamos, mas mantemos o render
                if(!hasData) resetStore(); 
                
                renderContent();
            }, (error) => {
                console.error("Erro no listener do Firebase:", error);
            });
        };

        // ==========================================
        // FUNÇÕES GLOBAIS (WINDOW)
        // ==========================================
        
        // Navegação e View
        window.setViewMode = (mode, oven = null) => {
            viewMode = mode;
            if (oven) currentOven = oven;
            
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            const btnGeral = document.getElementById('btn-GERAL');
            const btnConfig = document.getElementById('btn-CONFIG');
            
            if(btnGeral) btnGeral.classList.remove('bg-blue-600');
            if(btnConfig) btnConfig.classList.remove('active');

            if (mode === 'grid') {
                if(btnGeral) btnGeral.classList.add('bg-blue-600');
            } else if (mode === 'config') {
                if(btnConfig) btnConfig.classList.add('active');
            } else {
                const btn = document.getElementById(`btn-${currentOven}`);
                if (btn) btn.classList.add('active');
            }
            renderContent();
        };

        window.changeDate = (offset) => {
            selectedDate.setDate(selectedDate.getDate() + offset);
            updateDateUI();
            resetStore();
            renderContent(); 
            if (db) setupRealtimeListener();
        };

        // Sincronização de Inputs
        window.syncData = (oven, row, field, val) => {
            ovenDataStore[oven].rows[row][field] = val;
            saveToFirebase(oven);
        };

        window.syncSub = (oven, row, field, sub, val) => {
            ovenDataStore[oven].rows[row][field][sub] = val;
            saveToFirebase(oven);
            if (field === 'quebras') window.runQuebra(oven, row);
        };

        window.syncLinha = (oven, val) => {
            ovenDataStore[oven].linha = val;
            saveToFirebase(oven);
        };

        // Cálculos e Lógica
        window.attachCalculations = (oven) => {
            window.runCalcs(oven);
            for(let i=0; i<12; i++) window.runQuebra(oven, i);
        };

        window.runCalcs = (oven) => {
            const safeOven = oven.replace(/\s+/g, '-');
            let weightedScoreSum = 0; 
            let previousVolume = 0;   

            for (let i = 0; i < 12; i++) {
                const hInput = document.getElementById(`input-${safeOven}-${i}-qHora`);
                const aInput = document.getElementById(`input-${safeOven}-${i}-qAcum`);
                const volInput = document.getElementById(`input-${safeOven}-${i}-vol`);

                if (!hInput || !aInput || !volInput) continue;

                const hValStr = hInput.value.replace(',', '.');
                const volValStr = volInput.value.replace('.', '').replace(',', '.');
                const hVal = parseFloat(hValStr);
                const volVal = parseFloat(volValStr);

                if (!isNaN(hVal)) {
                    hInput.className = hVal >= configTargets.quality ? "input-quali-hora nav-input text-target-ok" : "input-quali-hora nav-input text-target-low";
                } else {
                    hInput.className = "input-quali-hora nav-input";
                }

                if (!isNaN(volVal) && !isNaN(hVal)) {
                    let deltaVol = volVal - previousVolume;
                    weightedScoreSum += deltaVol * hVal;

                    if (volVal > 0) {
                        const avg = weightedScoreSum / volVal;
                        aInput.value = avg.toFixed(2).replace('.', ',');
                        aInput.className = avg >= configTargets.quality ? "input-quali-acum text-target-ok" : "input-quali-acum text-target-low";
                    } else {
                        aInput.value = "";
                        aInput.className = "input-quali-acum";
                    }
                    previousVolume = volVal;
                } else if (!isNaN(volVal)) {
                    previousVolume = volVal;
                    aInput.value = "";
                    aInput.className = "input-quali-acum";
                } else {
                    aInput.value = "";
                    aInput.className = "input-quali-acum";
                }
            }
        };

        window.runQuebra = (oven, row) => {
            const data = ovenDataStore[oven].rows[row].quebras;
            let total = 0;
            data.forEach(s => {
                const ms = String(s || '').replace(',', '.').match(/[-+]?[0-9]*\.?[0-9]+/g);
                if (ms) ms.forEach(m => total += parseFloat(m));
            });
            const display = document.getElementById(`total-${oven}-${row}`);
            if (display) {
                display.innerText = total.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                display.className = `flex-grow flex items-center justify-center font-bold ${total <= configTargets.breakage ? 'text-target-ok' : 'text-target-low'}`;
            }
        };

        window.sugerirReferencia = (input, oven) => {
            const rowIndex = parseInt(input.closest('tr').dataset.row);
            const refDatalist = document.getElementById('ref-suggestions');
            if(!refDatalist) return;
            refDatalist.innerHTML = '';
            if (rowIndex > 0) {
                const prev = ovenDataStore[oven].rows[rowIndex - 1].ref;
                if (input.value && prev && prev.toLowerCase().startsWith(input.value.toLowerCase())) {
                    const opt = document.createElement('option'); opt.value = prev;
                    refDatalist.appendChild(opt);
                }
            }
        };

        // Configuração e Senha
        window.openPasswordModal = () => {
            const modal = document.getElementById('password-modal');
            const input = document.getElementById('admin-password');
            const error = document.getElementById('pwd-error');
            
            if (modal) {
                input.value = '';
                error.classList.add('hidden');
                modal.style.display = 'flex';
                setTimeout(() => input.focus(), 100);
            }
        };

        window.closePasswordModal = () => {
            document.getElementById('password-modal').style.display = 'none';
        };

        window.submitPassword = () => {
            const input = document.getElementById('admin-password');
            const error = document.getElementById('pwd-error');
            if (input.value === "admin321") {
                window.closePasswordModal();
                window.setViewMode('config');
            } else {
                error.classList.remove('hidden');
                input.value = '';
                input.focus();
            }
        };

        window.saveConfig = () => {
            const q = parseFloat(document.getElementById('config-quality').value);
            const b = parseFloat(document.getElementById('config-breakage').value);
            if (!isNaN(q) && !isNaN(b)) {
                configTargets.quality = q;
                configTargets.breakage = b;
                localStorage.setItem('cco_config_targets', JSON.stringify(configTargets));
                const saveBtn = document.querySelector('.config-container button:last-child');
                saveBtn.innerText = "Salvo!";
                saveBtn.classList.replace('bg-blue-600', 'bg-green-600');
                setTimeout(() => window.setViewMode('single', currentOven || 'FORNO 1'), 500);
            } else {
                alert("Valores inválidos.");
            }
        };

        window.cancelConfig = () => window.setViewMode('single', currentOven || 'FORNO 1');

        window.togglePresentation = () => {
            const overlay = document.getElementById('presentation-overlay');
            const cycleList = ovenList.filter(o => o !== 'FORNO 1');
            if (presentationInterval) {
                clearInterval(presentationInterval); clearInterval(countdownInterval);
                presentationInterval = null; 
                if(overlay) overlay.style.display = 'none';
            } else {
                const startOven = cycleList.includes(currentOven) ? currentOven : cycleList[0];
                window.setViewMode('single', startOven);
                if(overlay) overlay.style.display = 'block';
                countdownSeconds = 30;
                countdownInterval = setInterval(() => {
                    countdownSeconds--; if (countdownSeconds < 0) countdownSeconds = 29;
                    const timer = document.getElementById('presentation-timer');
                    if(timer) timer.innerText = countdownSeconds;
                }, 1000);
                presentationInterval = setInterval(() => {
                    const currentIdx = cycleList.indexOf(currentOven);
                    const nextIdx = (currentIdx + 1) % cycleList.length;
                    window.setViewMode('single', cycleList[nextIdx]);
                    countdownSeconds = 30;
                }, 30000);
            }
        };

        // ==========================================
        // RENDERIZAÇÃO
        // ==========================================
        const generateConfigHTML = () => {
            return `
                <div class="config-container">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-800 border-b pb-4">Configuração de Metas</h2>
                    <div class="mb-6">
                        <label class="block text-lg font-bold text-gray-700 mb-2">Meta de Qualidade (%):</label>
                        <input type="number" step="0.1" id="config-quality" class="w-full border-2 border-gray-300 rounded-lg p-3 text-center text-xl font-bold text-blue-600 focus:border-blue-500 outline-none" value="${configTargets.quality}">
                        <p class="text-sm text-gray-500 mt-2 text-center">Acima deste valor = <span class="text-green-600 font-bold">VERDE</span></p>
                    </div>
                    <div class="mb-8">
                        <label class="block text-lg font-bold text-gray-700 mb-2">Meta de Quebra (%):</label>
                        <input type="number" step="0.1" id="config-breakage" class="w-full border-2 border-gray-300 rounded-lg p-3 text-center text-xl font-bold text-red-600 focus:border-red-500 outline-none" value="${configTargets.breakage}">
                        <p class="text-sm text-gray-500 mt-2 text-center">Abaixo deste valor = <span class="text-green-600 font-bold">VERDE</span></p>
                    </div>
                    <div class="flex justify-between gap-4">
                        <button onclick="window.cancelConfig()" class="w-1/2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">Cancelar</button>
                        <button onclick="window.saveConfig()" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md">Salvar</button>
                    </div>
                </div>
            `;
        };

        const generateOvenHTML = (ovenName, isMini = false) => {
            const data = ovenDataStore[ovenName];
            const headerSize = isMini ? 'text-xs py-1' : 'text-xl py-2';
            const tableFontSize = isMini ? 'text-[0.6rem]' : 'text-xs';
            const safeOven = ovenName.replace(/\s+/g, '-');

            let rowsHTML = schedule.map((item, index) => {
                const rowData = data.rows[index];
                const rowBg = index % 2 !== 0 ? 'bg-gray-custom' : '';
                return `
                    <tr class="${rowBg}" data-oven="${ovenName}" data-row="${index}">
                        <td class="font-bold border-black ${isMini ? 'text-[0.7rem]' : 'text-sm'} p-0">
                            ${item.time}<span class="shift-stamp">${item.shift}</span>
                        </td>
                        <td class="border-black">
                            <input type="text" id="input-${safeOven}-${index}-ref" class="nav-input ref-input" list="ref-suggestions" value="${rowData.ref || ''}" 
                                oninput="window.syncData('${ovenName}', ${index}, 'ref', this.value); window.sugerirReferencia(this, '${ovenName}')">
                        </td>
                        <td class="border-black">
                            <select id="select-${safeOven}-${index}-turno" class="text-gray-700 font-medium nav-input" onchange="window.syncData('${ovenName}', ${index}, 'turno', this.value)">
                                <option value="" ${rowData.turno === '' ? 'selected' : ''}>-</option>
                                <option value="A" ${rowData.turno === 'A' ? 'selected' : ''}>A</option>
                                <option value="B" ${rowData.turno === 'B' ? 'selected' : ''}>B</option>
                                <option value="C" ${rowData.turno === 'C' ? 'selected' : ''}>C</option>
                            </select>
                        </td>
                        <td class="border-black">
                            <input type="text" inputmode="decimal" id="input-${safeOven}-${index}-vol" class="nav-input" value="${rowData.vol || ''}" 
                                oninput="window.syncData('${ovenName}', ${index}, 'vol', this.value); window.runCalcs('${ovenName}')">
                        </td>
                        <td class="border-black">
                            <input type="text" inputmode="decimal" id="input-${safeOven}-${index}-qHora" class="input-quali-hora nav-input" value="${rowData.qHora || ''}" 
                                data-oven="${ovenName}" oninput="window.syncData('${ovenName}', ${index}, 'qHora', this.value); window.runCalcs('${ovenName}')">
                        </td>
                        <td class="border-black">
                            <input type="text" id="input-${safeOven}-${index}-qAcum" class="input-quali-acum" data-oven="${ovenName}" readonly placeholder="0.00">
                        </td>
                        <td class="border-black p-0">
                            <div class="flex flex-col">
                                ${[0,1,2,3].map(i => `<input type="text" id="input-${safeOven}-${index}-defect-${i}" class="defect-input nav-input" placeholder="${i+1}." value="${rowData.defects[i] || ''}" oninput="window.syncSub('${ovenName}', ${index}, 'defects', ${i}, this.value)">`).join('')}
                            </div>
                        </td>
                        <td class="border-black p-0">
                            <div class="flex h-full">
                                <div class="flex flex-col flex-grow">
                                    ${[0,1,2,3].map(i => `<input type="text" id="input-${safeOven}-${index}-quebra-${i}" class="defect-input nav-input" placeholder="${i+1}." value="${rowData.quebras[i] || ''}" oninput="window.syncSub('${ovenName}', ${index}, 'quebras', ${i}, this.value)">`).join('')}
                                </div>
                                <div class="quebra-total-box">
                                    <div class="quebra-total-header uppercase">Total</div>
                                    <div class="flex-grow flex items-center justify-center font-bold ${isMini ? 'text-[0.6rem]' : 'text-xs'}" id="total-${ovenName}-${index}">0,00</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="border-b border-black text-center ${headerSize} font-bold uppercase bg-gray-50">Acompanhamento - ${ovenName}</div>
                <div class="flex border-b border-black font-bold uppercase text-[0.6rem] bg-white">
                    <div class="w-1/2 border-r border-black p-1 flex justify-center items-center">${ovenName}</div>
                    <div class="w-1/2 p-1 flex justify-center items-center gap-1">
                        <span>Linha:</span>
                        <select onchange="window.syncLinha('${ovenName}', this.value)" class="border border-gray-300 rounded px-1 font-normal text-red-600">
                            <option value="">-</option>
                            <option value="1" ${data.linha === '1' ? 'selected' : ''}>1</option>
                            <option value="2" ${data.linha === '2' ? 'selected' : ''}>2</option>
                            <option value="4" ${data.linha === '4' ? 'selected' : ''}>4</option>
                            <option value="5" ${data.linha === '5' ? 'selected' : ''}>5</option>
                            <option value="6" ${data.linha === '6' ? 'selected' : ''}>6</option>
                        </select>
                    </div>
                </div>
                <table class="w-full">
                    <thead>
                        <tr class="header-blue font-bold ${tableFontSize} leading-tight bg-gray-50">
                            <th class="w-12">Hora</th><th class="w-24">Referência</th><th class="w-14">Turno Esmaltação</th>
                            <th class="w-12">Volume</th><th class="w-16">Qualidade Hora (%)</th><th class="w-16">Qualidade Acumulada (%)</th>
                            <th class="w-24 italic">Defeitos</th><th class="w-32 text-red-600">Quebra (%)</th>
                        </tr>
                    </thead>
                    <tbody>${rowsHTML}</tbody>
                </table>
            `;
        };

        const renderContent = () => {
            const activeElement = document.activeElement;
            let focusedId = null;
            let cursorStart = null;
            let cursorEnd = null;

            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT')) {
                focusedId = activeElement.id;
                if (activeElement.type !== 'number' && activeElement.tagName === 'INPUT') {
                    try { cursorStart = activeElement.selectionStart; cursorEnd = activeElement.selectionEnd; } catch (e) {}
                }
            }

            const mainContent = document.getElementById('main-content');
            if(!mainContent) return;

            if (viewMode === 'config') {
                mainContent.className = "max-w-7xl mx-auto";
                mainContent.innerHTML = generateConfigHTML();
                return;
            } else if (viewMode === 'grid') {
                mainContent.className = "grid-view-container";
                const gridOvens = ovenList.filter(ov => ov !== 'FORNO 1');
                mainContent.innerHTML = gridOvens.map(ov => `<div class="oven-card p-1 rounded">${generateOvenHTML(ov, true)}</div>`).join('');
                gridOvens.forEach(ov => window.attachCalculations(ov));
            } else {
                mainContent.className = "max-w-7xl mx-auto bg-white shadow-lg border-t border-black";
                mainContent.innerHTML = generateOvenHTML(currentOven);
                window.attachCalculations(currentOven);
            }

            if (focusedId) {
                const el = document.getElementById(focusedId);
                if (el) {
                    el.focus();
                    if (cursorStart !== null && cursorEnd !== null) try { el.setSelectionRange(cursorStart, cursorEnd); } catch (e) {}
                }
            }
        };

        // ==========================================
        // INIT
        // ==========================================
        const init = async () => {
            resetStore();
            updateDateUI();
            renderContent();
            
            if(auth) {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) { console.error("Falha na autenticação:", e); }

                onAuthStateChanged(auth, (user) => {
                    if (user) setupRealtimeListener();
                });
            }

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    if (document.activeElement.id === 'admin-password') return;
                    e.preventDefault();
                    const inputs = Array.from(document.querySelectorAll('.nav-input'));
                    const idx = inputs.indexOf(e.target);
                    if (idx >= 0 && idx < inputs.length - 1) inputs[idx + 1].focus();
                }
            });
        };

        init();
    </script>
</body>
</html>
