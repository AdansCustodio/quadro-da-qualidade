<!DOCTYPE html>
<html lang="pt-br">
<head>
    <!-- Meta tag essencial para responsividade e bloqueio de zoom indesejado em inputs no iOS -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard de Qualidade - CCO Fornos e Ret√≠ficas</title>
    
    <!-- Framework CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* --- ESTILOS GERAIS E TIPOGRAFIA --- */
        body { font-size: 1.1rem; background-color: #e5e7eb; transition: background-color 0.3s ease; }
        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); }
        
        /* --- ESTRUTURA DA TABELA --- */
        table { border-collapse: collapse; width: 100%; transition: all 0.3s ease; }
        th, td { border: 1px solid black; text-align: center; padding: 2px; }
        .header-blue { color: #2563eb; }
        .bg-gray-custom { background-color: #f3f4f6; }
        .bg-gray-dark-custom { background-color: #9ca3af; } 
        
        /* --- INPUTS E CONTROLES --- */
        input, select { width: 100%; height: 100%; border: none; background: transparent; text-align: center; outline: none; font-size: 1rem; appearance: textfield; transition: background-color 0.2s; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input:focus, select:focus { background-color: #fef08a; /* Amarelo suave no foco para acessibilidade */ }
        
        .nav-input { width: 100%; height: 100%; }
        .sub-row { display: flex; border-bottom: 1px solid #ccc; height: 1.4rem; align-items: center; }
        .sub-row:last-child { border-bottom: none; }
        
        .input-cod { width: 30px; border-right: 1px solid #eee; font-size: 0.75rem; text-align: center; font-weight: bold; }
        .input-desc { flex-grow: 1; border-right: 1px solid #eee; font-size: 0.65rem; text-align: left; padding-left: 2px; background-color: #f9fafb; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .input-val { width: 40px; font-size: 0.75rem; text-align: center; font-weight: bold; color: #000; }
        .input-desc-editable { background-color: #ffffff !important; color: #000 !important; font-style: italic; border: 1px dashed #cbd5e1; }
        
        /* --- CORES DE STATUS (METAS) --- */
        .text-target-ok { color: #16a34a; font-weight: bold; }
        .text-target-low { color: #dc2626; font-weight: bold; }
        .text-stop-alert { color: #dc2626; font-weight: 900; font-size: 0.75rem; letter-spacing: 0.5px; }
        .shift-stamp { display: block; font-size: 0.55rem; color: #6b7280; line-height: 1; margin-top: 1px; text-transform: uppercase; }
        
        /* --- BOT√ïES E NAVEGA√á√ÉO --- */
        .tab-btn { transition: all 0.2s; border-bottom: 4px solid transparent; }
        .tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; background-color: #eff6ff; }
        .btn-config { background-color: #4b5563; color: white; border-radius: 4px; transition: background-color 0.2s; }
        .btn-config.active { background-color: #374151; box-shadow: 0 0 0 2px #9ca3af; }
        .btn-nav-date { background-color: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; transition: background-color 0.2s; }
        .btn-nav-date:hover { background-color: #e5e7eb; }
        .btn-force-reload { background-color: #16a34a; color: white; font-weight: bold; font-size: 0.7rem; border-radius: 4px; padding: 4px 8px; margin-left: 8px; text-transform: uppercase; box-shadow: 0 1px 2px rgba(0,0,0,0.2); transition: background-color 0.2s; }
        .btn-force-reload:hover { background-color: #15803d; }
        
        /* Bot√£o MODO MOBILE */
        .btn-mobile-toggle { background-color: #4f46e5; color: white; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 0.75rem; transition: all 0.3s; }
        .btn-mobile-toggle:hover { background-color: #4338ca; }
        .btn-mobile-toggle.active { background-color: #1f2937; } /* Fica escuro quando ativo */

        /* --- COMPONENTES ESPEC√çFICOS --- */
        .quebra-total-box { width: 50px; border-left: 1px solid #999; display: flex; flex-direction: column; background-color: #fafafa; }
        .quebra-total-header { font-size: 0.5rem; font-weight: bold; border-bottom: 1px solid #999; padding: 1px 0; background-color: #f0f0f0; color: #444; }
        
        /* Container de Rolagem Horizontal Suave (Essencial para n√£o quebrar tabelas grandes) */
        .table-responsive-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
        
        .config-container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 800px; margin: 20px auto; border: 1px solid #e5e7eb; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .config-header { grid-column: 1 / -1; border-bottom: 1px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 10px; }
        
        .defect-list-container { height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; background: #f9fafb; }
        .defect-item { display: flex; border-bottom: 1px solid #eee; padding: 4px; align-items: center; font-size: 0.8rem; }
        .defect-item:nth-child(even) { background-color: white; }
        .defect-item input { text-align: left; }
        
        /* Pain√©is Flutuantes (Modais e Lupa) */
        #password-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; }
        .pwd-content { background: white; padding: 25px; border-radius: 8px; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        
        #defect-lookup-panel { display: none; position: fixed; top: 90px; right: 20px; width: 350px; height: auto; max-height: 85vh; background: white; border: 2px solid #2563eb; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 2000; flex-direction: column; }
        .lookup-header { background-color: #f0f9ff; padding: 10px; border-bottom: 1px solid #bae6fd; display: flex; justify-content: space-between; align-items: center; border-radius: 6px 6px 0 0; }
        .lookup-content { padding: 10px; display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .lookup-list { overflow-y: auto; border: 1px solid #eee; margin-top: 5px; flex-grow: 1; border-radius: 4px; background-color: #fafafa; }
        .search-trigger { cursor: pointer; display: flex; align-items: center; justify-content: center; height: 100%; background-color: #f3f4f6; transition: all 0.2s; font-size: 0.85rem; color: #6b7280; }
        .search-trigger:hover { background-color: #dbeafe; color: #1e40af; }
        .sub-header-row { display: flex; font-size: 0.6rem; font-weight: bold; background: #e5e7eb; border-bottom: 1px solid #000; }
        .sh-cod { width: 30px; border-right: 1px solid #ccc; }
        .sh-desc { flex-grow: 1; border-right: 1px solid #ccc; }
        .sh-val { width: 40px; }
        
        #loading-indicator { display: none; margin-left: 10px; font-size: 0.75rem; color: #2563eb; font-weight: bold; align-items: center; gap: 5px; }
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #2563eb; border-radius: 50%; width: 12px; height: 12px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* TELA DE BLOQUEIO DE VERS√ÉO/LOCAL */
        #version-blocker { display: none; position: fixed; inset: 0; background: #111827; z-index: 9999; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; color: white; }

        /* =========================================
           MODO SMARTPHONE RESPONSIVO (MOBILE-FIRST)
           ========================================= */
        body.mobile-mode { padding: 0 !important; background-color: #f3f4f6; }
        
        /* Navbar no modo mobile */
        body.mobile-mode .navbar-container { padding: 0.5rem; overflow-x: auto; flex-wrap: nowrap; border-radius: 0; margin-bottom: 0; }
        body.mobile-mode .tab-btn { padding: 0.75rem 1rem; font-size: 0.8rem; } /* √Årea de toque maior (Acessibilidade) */
        
        /* Container principal vira 100vw */
        body.mobile-mode #main-content { max-width: 100vw; margin: 0; border: none; box-shadow: none; }
        
        /* For√ßa a tabela a ter uma largura m√≠nima para manter integridade dos dados, gerando scroll interno */
        body.mobile-mode table { min-width: 1100px; }
        body.mobile-mode th, body.mobile-mode td { font-size: 0.85rem; padding: 4px; }
        
        /* Inputs maiores para toque f√°cil no celular */
        body.mobile-mode input, body.mobile-mode select { min-height: 38px; }
        body.mobile-mode .sub-row { height: 2rem; }
    </style>
</head>
<body class="bg-gray-200 p-4 transition-all duration-300">

    <!-- OVERLAY DE BLOQUEIO DE SEGURAN√áA -->
    <div id="version-blocker">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-red-500 mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h1 class="text-4xl font-black text-red-500 mb-4 uppercase tracking-wider">Acesso Bloqueado</h1>
        <h2 id="version-blocker-title" class="text-2xl font-bold mb-4 text-gray-200">Voc√™ est√° usando uma vers√£o obsoleta ou n√£o oficial.</h2>
        <p id="version-blocker-desc" class="mb-8 text-gray-400 max-w-lg text-lg">Para garantir que os dados n√£o sejam perdidos e sejam salvos no servidor oficial, √© necess√°rio acessar o sistema pelo link correto da f√°brica.</p>
        <button onclick="window.location.href='https://mohawkllc.sharepoint.com/sites/QuadrodaQualidade/SitePages/Quadro-da-Qualidade---SC2.aspx?csf=1&web=1&share=IQAqn6oOhn5LR42F7_vGWyHNAdBd3R5izEZRhLTPc8jNSy4&e=Cy8NON&ovuser=04eca944-6c51-44b3-968f-d0b53acd3878%2cadans.custodio%40mohawkbr.com&OR=Teams-HL&CT=1771538670760&clickparams=eyJBcHBOYW1lIjoiVGVhbXMtRGVza3RvcCIsIkFwcFZlcnNpb24iOiI0OS8yNjAxMTUxMTExOCJ9&CID=bba1f8a1-a0ce-b000-ad7a-a59511aaaae4&cidOR=SPO'" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-xl shadow-lg transition-transform hover:scale-105 uppercase tracking-wide">
            Acessar Sistema Oficial
        </button>
    </div>

    <!-- Navega√ß√£o Superior -->
    <div class="navbar-container max-w-[98%] mx-auto mb-4 flex space-x-1 bg-white p-1 shadow-sm rounded-t-lg border-b overflow-x-auto items-center">
        
        <!-- BRAND LOGO MOHAWK BRASIL (Puro CSS/HTML) -->
        <div class="px-5 flex flex-col items-center justify-center border-r border-gray-300 mr-2 shrink-0 bg-white select-none py-1" aria-label="Logo Mohawk Brasil" title="Mohawk Brasil">
            <span class="text-gray-800 font-black tracking-tighter" style="font-family: Georgia, 'Times New Roman', Times, serif; font-size: 1.15rem; line-height: 0.85;">MOHAWK</span>
            <span class="text-red-700 font-bold tracking-[0.4em] ml-[0.4em]" style="font-family: Arial, Helvetica, sans-serif; font-size: 0.45rem; line-height: 1; margin-top: 3px;">BRASIL</span>
        </div>

        <!-- Bot√µes de Navega√ß√£o entre Equipamentos -->
        <!-- FORNO 1 MANTIDO OCULTO -->
        <button onclick="window.setViewMode('single', 'FORNO 1')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 active whitespace-nowrap" id="btn-FORNO 1" style="display:none;">Forno 1</button>
        <button onclick="window.setViewMode('single', 'FORNO 2')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 whitespace-nowrap" id="btn-FORNO 2">Forno 2</button>
        <button onclick="window.setViewMode('single', 'FORNO 3A')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 whitespace-nowrap" id="btn-FORNO 3A">Forno 3A</button>
        <button onclick="window.setViewMode('single', 'FORNO 3B')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 whitespace-nowrap" id="btn-FORNO 3B">Forno 3B</button>
        <button onclick="window.setViewMode('single', 'FORNO 4')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 whitespace-nowrap" id="btn-FORNO 4">Forno 4</button>
        <button onclick="window.setViewMode('single', 'RET√çFICA 1')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 whitespace-nowrap" id="btn-RET√çFICA 1">Ret√≠fica 1</button>
        <button onclick="window.setViewMode('single', 'RET√çFICA 2')" class="tab-btn px-4 py-2 font-bold uppercase text-xs hover:bg-gray-50 whitespace-nowrap" id="btn-RET√çFICA 2">Ret√≠fica 2</button>
        
        <!-- Controles de Data -->
        <div class="flex items-center px-4 space-x-2 border-l border-gray-300 ml-2 shrink-0">
            <button onclick="window.changeDate(-1)" class="btn-nav-date p-1" aria-label="Dia Anterior" title="Dia Anterior">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <div class="flex flex-col items-center min-w-[100px]">
                <span class="text-[10px] uppercase font-bold text-gray-500">Data Registro</span>
                <span id="display-date" class="text-xs font-black text-blue-700">--/--/----</span>
            </div>
            <button onclick="window.changeDate(1)" class="btn-nav-date p-1" aria-label="Pr√≥ximo Dia" title="Pr√≥ximo Dia">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
            <button onclick="window.setupRealtimeListener()" class="btn-force-reload" title="For√ßar atualiza√ß√£o dos dados">
                Carregar Dados
            </button>
        </div>

        <!-- Indicador de Status de Salvamento na Nuvem -->
        <div id="save-status" class="text-[0.65rem] font-bold text-gray-400 ml-4 flex items-center gap-1 min-w-[120px] shrink-0">
            <span class="w-2 h-2 rounded-full bg-gray-400" id="save-dot"></span>
            <span id="save-text">Nuvem Sincronizada</span>
        </div>
        
        <div id="loading-indicator" class="shrink-0">
            <div class="spinner"></div> Carregando...
        </div>
        
        <div class="flex-grow"></div>
        
        <!-- Bot√£o Novo: Alternar Layout Responsivo (Mobile) -->
        <button onclick="window.toggleMobileMode()" class="btn-mobile-toggle px-4 py-2 shadow-sm flex items-center gap-2 whitespace-nowrap mr-2 shrink-0" id="btn-MOBILE" aria-label="Alternar Layout Smartphone">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
            <span id="mobile-btn-text">ABRIR NO SMARTPHONE</span>
        </button>
        
        <!-- Bot√£o de Configura√ß√µes -->
        <button onclick="window.openPasswordModal()" class="btn-config px-3 py-2 shadow-sm flex items-center justify-center mr-2 shrink-0" id="btn-CONFIG" aria-label="Configura√ß√µes do Sistema" title="Configura√ß√µes">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        </button>
    </div>

    <!-- Modais e Menus Flutuantes -->
    <div id="password-modal">
        <div class="pwd-content">
            <h3 class="text-lg font-bold mb-4 text-gray-800">Acesso Restrito</h3>
            <p class="text-sm text-gray-600 mb-4">Digite a senha de administrador.</p>
            <input type="password" id="admin-password" class="w-full border-2 border-gray-300 rounded p-2 mb-4 text-center" placeholder="Senha">
            <div class="flex justify-between gap-2">
                <button onclick="window.closePasswordModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded font-bold text-sm">Cancelar</button>
                <button onclick="window.submitPassword()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-bold text-sm">Confirmar</button>
            </div>
            <p id="pwd-error" class="text-red-500 text-xs mt-2 hidden">Senha incorreta!</p>
        </div>
    </div>

    <!-- Painel Lupa Defeitos -->
    <div id="defect-lookup-panel">
        <div class="lookup-header">
            <h3 class="font-bold text-gray-800 text-sm" id="lookup-title">Lista de Defeitos</h3>
            <button onclick="window.toggleDefectList()" class="text-gray-500 hover:text-red-600 font-bold px-2" aria-label="Fechar Lista">‚úï</button>
        </div>
        <div class="lookup-content">
            <input type="text" id="defect-search" class="w-[150px] h-[50px] border border-blue-300 rounded p-2 text-xs focus:ring-2 focus:ring-blue-200 outline-none mb-2" placeholder="Pesquisar c√≥digo ou nome..." oninput="window.renderDefectLookup()">
            <div class="flex text-[10px] font-bold text-gray-500 px-2 border-b pb-1">
                <span class="w-12 text-center border-r">C√≥d</span>
                <span class="pl-2">Descri√ß√£o</span>
            </div>
            <div id="defect-lookup-list" class="lookup-list"></div>
        </div>
    </div>

    <!-- CONTE√öDO PRINCIPAL (Tabelas ou Config) -->
    <div id="main-content" class="max-w-7xl mx-auto transition-opacity duration-300"></div>
    <datalist id="ref-suggestions"></datalist>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- SISTEMA DE CONTROLE DE VERS√ÉO ---
        const APP_VERSION = 4.0; // Identidade Visual Headers + Smartphone Mode + Remove Grid

        const githubFirebaseConfig = {
            apiKey: "AIzaSyDiTXEU3jZOjsMMiYnM3myOLY7njgx9uQ0",
            authDomain: "quadro-da-qualidade.firebaseapp.com",
            databaseURL: "https://quadro-da-qualidade-default-rtdb.firebaseio.com",
            projectId: "quadro-da-qualidade",
            storageBucket: "quadro-da-qualidade.firebasestorage.app",
            messagingSenderId: "736566707005",
            appId: "1:736566707005:web:f33e4450ea82e375b07b54",
            measurementId: "G-JYGSP8BQW8"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : githubFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, auth, db;
        try {
            if (firebaseConfig.apiKey) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) { console.error("Erro Firebase:", e); }

        // Sementes Padr√£o
        const seedOvenDefects = {
            "1": "Arranhado", "2": "Empeno por Vazio", "3": "Pingo de Tinta", "4": "Covinha", "5": "sem registro", "7": "Pingo Preto", "9": "Ponta Vidrada", "10": "Risco de Veu",
            "11": "Pingo de Tinta", "12": "Ponta Quebrada Esmalta√ß√£o", "13": "Lascado de esmalta√ß√£o", "14": "Sujeira de Esmalte", "15": "Furo Esmalte",
            "18": "Pingo de Engobe", "25": "Martelado", "26": "Pedrinha", "27": "Pin Holles", "28": "Retra√ß√£o Formo", "29": "Ra Lateral",
            "30": "Sujeira de Forno", "31": "Encavalado", "33": "Pereba", "34": "Ra Canto", "35": "RA Centro", "36": "Aresta",
            "37": "Sujeira de Biscoito", "38": "Falhado", "41": "Lascado de classifica√ß√£o", "42": "Riscado", "45": "Retra√ß√£o Esmalte", "47": "Massa contaminada",
            "48": "A no C", "54": "Ponta Quebrada Classifica√ß√£o", "60": "Sujeira de Rebarbador", "64": "Pingo d'agua", "73": "Falha de Veu",
            "74": "Pe√ßa de Prova", "75": "Pe√ßas estouradas", "77": "Quebra de sa√≠da", "78": "Fora de tom", "80": "Quebra p/Trancamento", "85": "Onda Veu",
            "88": "Grumo de esmalte", "93": "Pingo de Cobertura", "94": "Desc p/ Tam GG", "96": "Desti p/ Trapezio", "97": "Desi p/ Luneta",
            "98": "Desc/ Empeno", "99": "Outros", "95": "Quebra do Robo", "106": "Deformado", "109": "Marca de Lixa",
            "110": "Pingo de chuva", "111": "Reprensado", "113": "Risco de Decoradora Digital", "114": "Quebra de empilhador", "116": "Quebra de Estocagem",
            "119": "Falha de Digital", "127": "Empeno", "129": "Arranhado de prensa", "130": "Pe√ßas Cruas"
        };
        const seedGrinderDefects = {
            "1": "Arranhado", "2": "Empeno por Vazio", "3": "sem registro", "4": "Covinha", "5": "sem registro", "7": "Pingo Preto", "10": "Risco de V√©u",
            "14": "Sujeira de Esmalte", "15": "Furo no Esmalte", "18": "Pingo de Engobe", "26": "Pedrinha",
            "29": "RA Lateral", "30": "Sujeira de Forno", "34": "RA Canto", "35": "RA Centro",
            "37": "Sujeira de Biscoito", "38": "Falhado", "41": "Lascado", "45": "Retra√ß√£o de Esmalte",
            "47": "Massa Contaminada", "54": "Ponta Quebrada", "60": "Sujeira Rebarbador", "64": "Pingo d'√°gua",
            "73": "Falha de V√©u", "78": "Fora de Ton", "80": "Quebra por Trancamento", "85": "Onda de V√©u",
            "88": "Grumo no Esmalte", "93": "Pingo de Cobertura", "99": "Outros", "111": "Reprensado",
            "113": "Risco de Decoradora Digital", "106": "Deformado", "109": "Marca de Lixa", "114": "Quebra de Empilhador",
            "116": "Quebra de Estocagem", "117": "Material Molhado", "119": "Falha de Digital", "127": "Empeno",
            "49": "Fora de Calibre", "118": "Diagonal", "123": "Serrilhado", "122": "Chanfrado", "124": "Quebra de Retifica"
        };

        let ovenDefectMap = { ...seedOvenDefects };
        let grinderDefectMap = { ...seedGrinderDefects };
        let configDefectMode = 'ovens';
        let lookupOven = 'FORNO 2';

        const getDefectMapForOven = (ovenName) => ovenName && ovenName.includes('RET√çFICA') ? grinderDefectMap : ovenDefectMap;

        const ovenList = ['FORNO 1', 'FORNO 2', 'FORNO 3A', 'FORNO 3B', 'FORNO 4', 'RET√çFICA 1', 'RET√çFICA 2'];
        const scheduleOvens = [
            { time: "21:30", shift: "TC" }, { time: "23:30", shift: "TC" }, { time: "01:30", shift: "TC" }, { time: "03:30", shift: "TC" },
            { time: "05:30", shift: "TA" }, { time: "07:30", shift: "TA" }, { time: "09:30", shift: "TA" }, { time: "11:30", shift: "TA" },
            { time: "13:30", shift: "TB" }, { time: "15:30", shift: "TB" }, { time: "17:30", shift: "TB" }, { time: "19:30", shift: "TB" }
        ];
        const scheduleGrinders = [
            { time: "23:00", shift: "TC" }, { time: "01:00", shift: "TC" }, { time: "03:00", shift: "TC" }, { time: "05:00", shift: "TC" },
            { time: "07:00", shift: "TA" }, { time: "09:00", shift: "TA" }, { time: "11:00", shift: "TA" }, { time: "13:00", shift: "TA" },
            { time: "15:00", shift: "TB" }, { time: "17:00", shift: "TB" }, { time: "19:00", shift: "TB" }, { time: "21:00", shift: "TB" }
        ];

        let currentOven = 'FORNO 2';
        let viewMode = 'single'; // Somente 'single' ou 'config' a partir da v4.0
        let isMobileLayoutActive = false; // Controle de layout Mobile Responsive
        
        let selectedDate = new Date();
        let lastKnownDay = new Date().getDate();
        let lastBackupHour = new Date().getHours(); // NOVO: Controle exato de hora para o Cofre
        let isDataLoaded = false; 
        let unsubscribeRealtimeList = []; 
        let unsubscribeDefects = null; 
        let availableBackups = [];

        let globalConfig = {
            ovens: { quality: 97.0, breakage: 1.2 },
            grinders: { quality: 97.0, breakage: 1.2 },
            minVersion: APP_VERSION 
        };

        const saveTimeouts = {};
        const ovenDataStore = {};

        // --- SISTEMA DE BACKUP E RESTAURA√á√ÉO ---
        window.runManualBackup = async (overrideDate = null, isAuto = false) => {
            if (!db || !isDataLoaded) return;
            setSaveStatus('saving');
            
            // Usar data de override se fornecida (na virada de meia-noite), sen√£o usa a data atual
            const targetDate = overrideDate instanceof Date ? overrideDate : selectedDate;
            const dateKey = getDateKey(targetDate);
            const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }).replace(':', 'h');
            
            try {
                // Clona os dados na mem√≥ria AGORA para evitar corrida de dados se a tela limpar
                const dataSnapshot = {};
                for (const oven of ovenList) {
                    if (ovenDataStore[oven]) {
                        dataSnapshot[oven] = JSON.parse(JSON.stringify(ovenDataStore[oven]));
                    }
                }

                for (const oven of ovenList) {
                    const data = dataSnapshot[oven];
                    // Salva apenas se o equipamento teve alguma produ√ß√£o ou apontamento
                    if (data && data.rows && data.rows.some(r => r.vol || r.ref)) {
                        const backupDocId = `${oven}_${dateKey}_[${timestamp}]`;
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'backups', backupDocId);
                        await setDoc(docRef, data);
                    }
                }
                
                // Exibe o alerta APENAS se foi clicado manualmente pelo bot√£o amarelo (n√£o exibe nos autom√°ticos)
                if (!isAuto) alert("Backup de seguran√ßa salvo com sucesso na Nuvem!");
                
                setSaveStatus('saved');
            } catch(e) { 
                console.error("Erro ao realizar backup", e); 
                setSaveStatus('error'); 
            }
        };

        window.searchBackups = async () => {
            const oven = document.getElementById('backup-oven-select').value;
            const date = document.getElementById('backup-date-select').value;
            if (!db || !oven || !date) return;
            setSaveStatus('saving');
            document.getElementById('save-text').innerText = "Buscando...";
            try {
                const backupsRef = collection(db, 'artifacts', appId, 'public', 'data', 'backups');
                const snapshot = await getDocs(backupsRef);
                availableBackups = [];
                const searchPrefix = `${oven}_${date}`;
                snapshot.forEach(doc => { if (doc.id.startsWith(searchPrefix)) availableBackups.push({ id: doc.id, data: doc.data() }); });
                
                const container = document.getElementById('backup-results-container');
                const select = document.getElementById('backup-file-select');
                if (availableBackups.length > 0) {
                    availableBackups.sort((a, b) => b.id.localeCompare(a.id));
                    select.innerHTML = availableBackups.map((b, index) => {
                        const timeMatch = b.id.match(/\[(.*?)\]/);
                        const timeStr = timeMatch ? timeMatch[1] : 'Hora Desconhecida';
                        return `<option value="${index}">C√≥pia salva √†s ${timeStr}</option>`;
                    }).join('');
                    container.style.display = 'block';
                    setSaveStatus('saved');
                    document.getElementById('save-text').innerText = `${availableBackups.length} c√≥pias achadas`;
                } else {
                    container.style.display = 'none';
                    alert(`Nenhum backup encontrado para ${oven} no dia ${date}.`);
                    setSaveStatus('saved');
                }
            } catch (error) { console.error("Erro ao buscar backups:", error); setSaveStatus('error'); }
        };

        window.restoreBackup = async () => {
            const select = document.getElementById('backup-file-select');
            const selectedIndex = select.value;
            if (selectedIndex === "" || !availableBackups[selectedIndex]) return;
            const backupToRestore = availableBackups[selectedIndex];
            const oven = document.getElementById('backup-oven-select').value;
            const date = document.getElementById('backup-date-select').value;
            if (confirm(`‚ö†Ô∏è ALERTA VERMELHO! ‚ö†Ô∏è\n\nVoc√™ est√° prestes a APAGAR e SUBSTITUIR todos os dados que est√£o hoje no ${oven} (Data: ${date}) pelos dados dessa c√≥pia de seguran√ßa.\n\nTem certeza absoluta disso?`)) {
                try {
                    setSaveStatus('saving');
                    const docId = `${oven}_${date}`; 
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'records', docId);
                    await setDoc(docRef, backupToRestore.data);
                    alert("‚úÖ C√≥pia de seguran√ßa restaurada com sucesso!");
                    setSaveStatus('saved');
                    window.setViewMode('single', oven);
                    const [y, m, d] = date.split('-');
                    selectedDate = new Date(y, m - 1, d);
                    updateDateUI();
                    window.setupRealtimeListener(); 
                } catch(error) { console.error("Erro ao restaurar", error); setSaveStatus('error'); alert("Erro ao restaurar dados."); }
            }
        };

        // --- FIREBASE SETTINGS E LISTENERS ---
        const loadGlobalConfig = async () => {
            if(!db) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    globalConfig = docSnap.data();
                    if (globalConfig.minVersion && APP_VERSION < parseFloat(globalConfig.minVersion)) {
                        document.getElementById('version-blocker-title').innerText = "Atualiza√ß√£o Necess√°ria";
                        document.getElementById('version-blocker-desc').innerText = `Voc√™ est√° usando a vers√£o ${APP_VERSION}, mas exige a vers√£o ${globalConfig.minVersion}.`;
                        document.getElementById('version-blocker').style.display = 'flex';
                        return; 
                    }
                } else await setDoc(docRef, globalConfig);
            } catch(e) { console.error("Erro config:", e); }
        };

        const saveGlobalConfigFirebase = async () => {
            if(!db) return;
            try { globalConfig.minVersion = APP_VERSION; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), globalConfig); }
            catch(e) { console.error(e); alert("Erro ao salvar."); }
        };

        const setupDefectsListener = () => {
            if (!db) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'defects');
            unsubscribeDefects = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.ovens) ovenDefectMap = data.ovens;
                    if(data.grinders) grinderDefectMap = data.grinders;
                    if (viewMode === 'config') renderContent();
                    const panel = document.getElementById('defect-lookup-panel');
                    if (panel && panel.style.display === 'flex') window.renderDefectLookup();
                } else setDoc(docRef, { ovens: seedOvenDefects, grinders: seedGrinderDefects });
            }, (error) => console.error("Erro ouvir defeitos:", error));
        };

        const saveDefectsToFirebase = async () => {
            if(!db) return;
            setSaveStatus('saving');
            try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'defects'), { ovens: ovenDefectMap, grinders: grinderDefectMap }); setSaveStatus('saved'); }
            catch(e) { setSaveStatus('error'); }
        };

        // --- ESTRUTURA DE DADOS ---
        const createEmptySubRow = () => ({ cod: '', desc: '', val: '' });
        const createEmptyOvenData = () => ({
            linha: '', targets: null, 
            rows: Array(12).fill(null).map(() => ({ 
                ref: '', turno: '', vol: '', qHora: '', 
                defects: [createEmptySubRow(), createEmptySubRow(), createEmptySubRow(), createEmptySubRow()],
                quebras: [createEmptySubRow(), createEmptySubRow(), createEmptySubRow(), createEmptySubRow()] 
            })),
            closing: [ { prod: '', quebra: '' }, { prod: '', quebra: '' }, { prod: '', quebra: '' } ]
        });

        const resetStore = () => ovenList.forEach(ov => { ovenDataStore[ov] = createEmptyOvenData(); });

        const getDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

        const updateDateUI = () => document.getElementById('display-date').innerText = `${selectedDate.getDate().toString().padStart(2, '0')}/${(selectedDate.getMonth() + 1).toString().padStart(2, '0')}/${selectedDate.getFullYear()}`;

        const setSaveStatus = (status) => {
            const dot = document.getElementById('save-dot'), text = document.getElementById('save-text');
            if(!dot || !text) return;
            if(status === 'saving') { dot.className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse"; text.innerText = "Salvando..."; text.className = "text-yellow-600"; }
            else if(status === 'saved') { 
                dot.className = "w-2 h-2 rounded-full bg-green-500"; text.innerText = "Salvo na Nuvem"; text.className = "text-green-600";
                setTimeout(() => { dot.className = "w-2 h-2 rounded-full bg-gray-400"; text.innerText = "Nuvem Sincronizada"; text.className = "text-gray-400"; }, 3000);
            } else if(status === 'error') { dot.className = "w-2 h-2 rounded-full bg-red-600"; text.innerText = "Erro ao Salvar"; text.className = "text-red-600"; }
        };

        const saveToFirebase = (ovenId) => {
            if (!db || !ovenDataStore[ovenId] || !isDataLoaded) return;
            if (saveTimeouts[ovenId]) clearTimeout(saveTimeouts[ovenId]);
            setSaveStatus('saving');
            if (!ovenDataStore[ovenId].targets) ovenDataStore[ovenId].targets = { ...globalConfig[ovenId.includes('RET√çFICA') ? 'grinders' : 'ovens'] };
            const dataToSave = JSON.parse(JSON.stringify(ovenDataStore[ovenId]));
            saveTimeouts[ovenId] = setTimeout(async () => {
                try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'records', `${ovenId}_${getDateKey(selectedDate)}`), dataToSave); setSaveStatus('saved'); }
                catch (e) { setSaveStatus('error'); }
            }, 1000);
        };

        const toggleLoading = (show) => { const el = document.getElementById('loading-indicator'); if(el) el.style.display = show ? 'flex' : 'none'; };

        window.setupRealtimeListener = () => {
            if (!db) return;
            unsubscribeRealtimeList.forEach(unsub => unsub()); unsubscribeRealtimeList = [];
            isDataLoaded = false; renderContent(); toggleLoading(true);
            const dateKey = getDateKey(selectedDate);
            let loadedCount = 0; 
            ovenList.forEach(ovenName => {
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'records', `${ovenName}_${dateKey}`), (docSnap) => {
                    if (docSnap.exists()) {
                        let data = docSnap.data();
                        data.rows.forEach(r => {
                            if (!r.defects || r.defects.length === 0) r.defects = [createEmptySubRow(), createEmptySubRow(), createEmptySubRow(), createEmptySubRow()];
                            if (!r.quebras || r.quebras.length === 0) r.quebras = [createEmptySubRow(), createEmptySubRow(), createEmptySubRow(), createEmptySubRow()];
                        });
                        if (!data.closing) data.closing = [ { prod: '', quebra: '' }, { prod: '', quebra: '' }, { prod: '', quebra: '' } ];
                        if (!data.targets) data.targets = null;
                        ovenDataStore[ovenName] = data;
                    } else ovenDataStore[ovenName] = createEmptyOvenData();
                    loadedCount++;
                    if (loadedCount >= ovenList.length) { isDataLoaded = true; toggleLoading(false); renderContent(); }
                    else if (isDataLoaded) renderContent();
                }, (error) => { loadedCount++; if (loadedCount >= ovenList.length) { isDataLoaded = true; toggleLoading(false); renderContent(); } });
                unsubscribeRealtimeList.push(unsub);
            });
        };

        window.changeDate = (offset) => { selectedDate.setDate(selectedDate.getDate() + offset); updateDateUI(); resetStore(); window.setupRealtimeListener(); };

        // Controle do Layout Flex√≠vel (Mobile Responsivo)
        window.toggleMobileMode = () => {
            isMobileLayoutActive = !isMobileLayoutActive;
            const btn = document.getElementById('btn-MOBILE');
            const text = document.getElementById('mobile-btn-text');
            
            if (isMobileLayoutActive) {
                document.body.classList.add('mobile-mode');
                btn.classList.add('active');
                text.innerText = 'üíª MODO DESKTOP';
            } else {
                document.body.classList.remove('mobile-mode');
                btn.classList.remove('active');
                text.innerText = 'üì± ABRIR NO SMARTPHONE';
            }
        };

        window.setViewMode = (mode, oven = null) => {
            viewMode = mode;
            if (oven) currentOven = oven;
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-CONFIG')?.classList.remove('active');
            if (mode === 'config') document.getElementById('btn-CONFIG')?.classList.add('active');
            else document.getElementById(`btn-${currentOven}`)?.classList.add('active');
            renderContent();
        };

        window.syncData = (oven, row, field, val) => {
            if (!isDataLoaded) return; 
            if (field === 'ref') {
                const el = document.getElementById(`input-${oven.replace(/\s+/g, '-')}-${row}-ref`);
                if (oven.includes('RET√çFICA')) {
                    if (val.trim().toUpperCase() === 'X') { val = "EQUIPAMENTO PARADO"; if(el) { el.value = val; el.classList.add('text-stop-alert'); } }
                    else if (val === "EQUIPAMENTO PARADO") { if(el) el.classList.add('text-stop-alert'); }
                    else { if(el) el.classList.remove('text-stop-alert'); }
                } else {
                    if (val.trim().toLowerCase() === 'x') { val = "‚ùåFORNO PARADO‚ö†Ô∏è"; if(el) el.value = val; }
                    if (val === "‚ùåFORNO PARADO‚ö†Ô∏è") { if(el) el.classList.add('text-red-600', 'font-black'); }
                    else { if(el) el.classList.remove('text-red-600', 'font-black'); }
                }
            }
            ovenDataStore[oven].rows[row][field] = val; saveToFirebase(oven);
        };

        window.syncClosing = (oven, index, field, val) => { if (isDataLoaded) { ovenDataStore[oven].closing[index][field] = val; saveToFirebase(oven); } };
        window.syncLinha = (oven, val) => { if (isDataLoaded) { ovenDataStore[oven].linha = val; saveToFirebase(oven); } };

        window.updateSubStruct = (oven, row, type, index, field, val) => {
            if (!isDataLoaded) return;
            if (!ovenDataStore[oven].rows[row][type][index]) ovenDataStore[oven].rows[row][type][index] = createEmptySubRow();
            ovenDataStore[oven].rows[row][type][index][field] = val;
            if (field === 'cod') {
                const desc = getDefectMapForOven(oven)[val] || (val ? "Desconhecido" : "");
                ovenDataStore[oven].rows[row][type][index]['desc'] = desc;
                const descInput = document.getElementById(`input-${oven}-${row}-${type}-${index}-desc`);
                if(descInput) {
                    descInput.value = desc;
                    if (val === '99') { descInput.removeAttribute('readonly'); descInput.classList.remove('bg-gray-50', 'text-gray-500'); descInput.classList.add('input-desc-editable'); descInput.focus(); }
                    else { descInput.setAttribute('readonly', true); descInput.classList.add('bg-gray-50', 'text-gray-500'); descInput.classList.remove('input-desc-editable'); }
                }
            }
            saveToFirebase(oven); if (type === 'quebras') window.runQuebra(oven, row);
        };

        window.attachCalculations = (oven) => { window.runCalcs(oven); for(let i=0; i<12; i++) window.runQuebra(oven, i); };

        window.runCalcs = (oven) => {
            const safeOven = oven.replace(/\s+/g, '-');
            let targetQ = ovenDataStore[oven]?.targets?.quality || globalConfig[oven.includes('RET√çFICA') ? 'grinders' : 'ovens'].quality;
            let weightedScoreSum = 0, previousVolume = 0;   
            for (let i = 0; i < 12; i++) {
                const hInput = document.getElementById(`input-${safeOven}-${i}-qHora`), aInput = document.getElementById(`input-${safeOven}-${i}-qAcum`), volInput = document.getElementById(`input-${safeOven}-${i}-vol`);
                if (!hInput || !aInput || !volInput) continue;
                const hVal = parseFloat(hInput.value.replace(',', '.')), volVal = parseFloat(volInput.value.replace('.', '').replace(',', '.'));
                hInput.className = !isNaN(hVal) ? (hVal >= targetQ ? "input-quali-hora nav-input text-target-ok" : "input-quali-hora nav-input text-target-low") : "input-quali-hora nav-input";
                if (!isNaN(volVal) && !isNaN(hVal)) {
                    let deltaVol = volVal - previousVolume; weightedScoreSum += deltaVol * hVal;
                    if (volVal > 0) {
                        const avg = weightedScoreSum / volVal; aInput.value = avg.toFixed(1).replace('.', ',');
                        aInput.className = avg >= targetQ ? "input-quali-acum text-target-ok" : "input-quali-acum text-target-low";
                    }
                    previousVolume = volVal;
                } else if (!isNaN(volVal)) previousVolume = volVal;
            }
        };

        window.runQuebra = (oven, row) => {
            let targetB = ovenDataStore[oven]?.targets?.breakage || globalConfig[oven.includes('RET√çFICA') ? 'grinders' : 'ovens'].breakage;
            let total = 0;
            ovenDataStore[oven].rows[row].quebras.forEach(item => { if (item && item.val) { const v = parseFloat(item.val.replace(',', '.')); if (!isNaN(v)) total += v; } });
            const display = document.getElementById(`total-${oven}-${row}`);
            if (display) { display.innerText = total.toLocaleString('pt-BR', { minimumFractionDigits: 2 }); display.className = `flex-grow flex items-center justify-center font-bold ${total <= targetB ? 'text-target-ok' : 'text-target-low'}`; }
        };

        window.sugerirReferencia = (input, oven) => {
            const row = parseInt(input.closest('tr').dataset.row), datalist = document.getElementById('ref-suggestions');
            if(!datalist) return; datalist.innerHTML = '';
            if (row > 0) {
                const prev = ovenDataStore[oven].rows[row - 1].ref;
                if (input.value && prev && prev.toLowerCase().startsWith(input.value.toLowerCase())) { const opt = document.createElement('option'); opt.value = prev; datalist.appendChild(opt); }
            }
        };

        window.setConfigDefectMode = (mode) => { configDefectMode = mode; renderContent(); };
        window.addDefect = async () => {
            const code = document.getElementById('new-defect-code').value.trim(), desc = document.getElementById('new-defect-desc').value.trim();
            if(code && desc) { (configDefectMode === 'ovens' ? ovenDefectMap : grinderDefectMap)[code] = desc; await saveDefectsToFirebase(); document.getElementById('new-defect-code').value = ''; document.getElementById('new-defect-desc').value = ''; }
            else alert("Preencha c√≥digo e descri√ß√£o.");
        };
        window.deleteDefect = async (code) => { if(confirm(`Remover defeito ${code}?`)) { delete (configDefectMode === 'ovens' ? ovenDefectMap : grinderDefectMap)[code]; await saveDefectsToFirebase(); } };
        window.updateDefectDesc = async (code, desc) => { (configDefectMode === 'ovens' ? ovenDefectMap : grinderDefectMap)[code] = desc; await saveDefectsToFirebase(); };
        
        window.toggleDefectList = (ovenName = currentOven) => {
            lookupOven = ovenName; const panel = document.getElementById('defect-lookup-panel');
            if (panel.style.display === 'flex') panel.style.display = 'none';
            else { panel.style.display = 'flex'; document.getElementById('defect-search').value = ''; document.getElementById('defect-search').focus(); document.getElementById('lookup-title').innerText = lookupOven.includes('RET√çFICA') ? "Lista de Defeitos (RET√çFICAS)" : "Lista de Defeitos (FORNOS)"; window.renderDefectLookup(); }
        };

        window.renderDefectLookup = () => {
            const filter = document.getElementById('defect-search').value.toLowerCase();
            document.getElementById('defect-lookup-list').innerHTML = Object.entries(getDefectMapForOven(lookupOven)).sort((a,b) => parseInt(a[0]) - parseInt(b[0]))
                .filter(([c, d]) => c.includes(filter) || d.toLowerCase().includes(filter))
                .map(([c, d]) => `<div class="flex border-b border-gray-100 py-1 hover:bg-blue-50 px-2 cursor-default"><span class="w-12 font-bold text-center text-blue-800 border-r text-[10px]">${c}</span><span class="flex-grow pl-2 text-left text-gray-700 text-[10px] flex items-center">${d}</span></div>`).join('');
        };

        window.openPasswordModal = () => { document.getElementById('pwd-error').classList.add('hidden'); document.getElementById('admin-password').value = ''; document.getElementById('password-modal').style.display = 'flex'; setTimeout(() => document.getElementById('admin-password').focus(), 100); };
        window.closePasswordModal = () => document.getElementById('password-modal').style.display = 'none';
        window.submitPassword = () => { if (document.getElementById('admin-password').value === "admin321") { window.closePasswordModal(); window.setViewMode('config'); } else document.getElementById('pwd-error').classList.remove('hidden'); };
        window.saveConfig = () => {
            const oQ = parseFloat(document.getElementById('config-quality-oven').value), oB = parseFloat(document.getElementById('config-breakage-oven').value), gQ = parseFloat(document.getElementById('config-quality-grinder').value), gB = parseFloat(document.getElementById('config-breakage-grinder').value);
            if (!isNaN(oQ) && !isNaN(oB) && !isNaN(gQ) && !isNaN(gB)) {
                globalConfig = { ovens: { quality: oQ, breakage: oB }, grinders: { quality: gQ, breakage: gB }, minVersion: APP_VERSION }; saveGlobalConfigFirebase();
                ovenList.forEach(ov => { if (ovenDataStore[ov]) ovenDataStore[ov].targets = { ...globalConfig[ov.includes('RET√çFICA') ? 'grinders' : 'ovens'] }; });
                alert("Metas cadastradas!"); window.setViewMode('single', currentOven || 'FORNO 2');
            } else alert("Valores inv√°lidos.");
        };
        window.cancelConfig = () => window.setViewMode('single', currentOven || 'FORNO 2');

        const generateDefectListHTML = () => Object.entries(configDefectMode === 'ovens' ? ovenDefectMap : grinderDefectMap).sort((a,b) => parseInt(a[0]) - parseInt(b[0])).map(([code, desc]) => `
            <div class="defect-item">
                <div class="w-16 font-bold text-center border-r border-gray-300 pr-2">${code}</div>
                <div class="flex-grow px-2"><input type="text" id="config-defect-desc-${code}" class="w-full bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none" value="${desc}" onchange="window.updateDefectDesc('${code}', this.value)"></div>
                <button onclick="window.deleteDefect('${code}')" class="text-red-500 font-bold px-2">‚úï</button>
            </div>`).join('');

        const generateConfigHTML = () => `
            <div class="config-container">
                <div class="config-header"><h2 class="text-2xl font-bold text-gray-800">Configura√ß√µes do Sistema</h2></div>
                <div>
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">Metas Globais</h3>
                    <div class="p-3 bg-blue-50 rounded mb-4 border"><h4 class="font-bold mb-2">FORNOS (Std)</h4><div class="mb-2"><label class="text-xs font-bold">Qualidade (%):</label><input type="number" step="0.1" id="config-quality-oven" class="w-full border p-1 text-center font-bold text-blue-600" value="${globalConfig.ovens.quality}"></div><div><label class="text-xs font-bold">Quebra (%):</label><input type="number" step="0.1" id="config-breakage-oven" class="w-full border p-1 text-center font-bold text-red-600" value="${globalConfig.ovens.breakage}"></div></div>
                    <div class="p-3 bg-gray-100 rounded mb-4 border"><h4 class="font-bold mb-2">RET√çFICAS (Std)</h4><div class="mb-2"><label class="text-xs font-bold">Qualidade (%):</label><input type="number" step="0.1" id="config-quality-grinder" class="w-full border p-1 text-center font-bold text-blue-600" value="${globalConfig.grinders.quality}"></div><div><label class="text-xs font-bold">Quebra (%):</label><input type="number" step="0.1" id="config-breakage-grinder" class="w-full border p-1 text-center font-bold text-red-600" value="${globalConfig.grinders.breakage}"></div></div>
                    <div class="flex flex-col gap-3 mt-8"><button onclick="window.saveConfig()" class="bg-blue-600 text-white font-bold py-3 rounded uppercase text-sm">Salvar Metas</button><button onclick="window.cancelConfig()" class="bg-gray-500 text-white font-bold py-2 rounded uppercase text-sm">Voltar</button></div>
                    <div class="mt-8 p-3 bg-yellow-50 rounded border"><h4 class="font-bold text-yellow-800 text-sm uppercase">Restaurar C√≥pia</h4><div class="flex gap-2 mb-2"><select id="backup-oven-select" class="border p-1 text-xs rounded w-1/2">${ovenList.map(o => `<option value="${o}" ${o === currentOven ? 'selected' : ''}>${o}</option>`).join('')}</select><input type="date" id="backup-date-select" class="border p-1 text-xs rounded w-1/2" value="${getDateKey(selectedDate)}"></div><button onclick="window.searchBackups()" class="bg-gray-700 text-white font-bold py-2 px-4 rounded text-xs w-full mb-2">Localizar C√≥pias</button><div id="backup-results-container" style="display:none;" class="mt-4 border-t pt-3"><select id="backup-file-select" class="border p-2 text-xs rounded w-full mb-2"></select><button onclick="window.restoreBackup()" class="bg-red-600 text-white font-bold py-2 px-4 rounded text-xs w-full">Restaurar Dados</button></div></div>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">Cadastro de Defeitos</h3>
                    <div class="flex justify-center gap-4 mb-4"><label><input type="radio" name="defect-mode" ${configDefectMode === 'ovens' ? 'checked' : ''} onchange="window.setConfigDefectMode('ovens')"><span class="ml-1 font-bold text-sm">Fornos</span></label><label><input type="radio" name="defect-mode" ${configDefectMode === 'grinders' ? 'checked' : ''} onchange="window.setConfigDefectMode('grinders')"><span class="ml-1 font-bold text-sm">Ret√≠ficas</span></label></div>
                    <div class="flex gap-2 mb-2"><input type="text" id="new-defect-code" placeholder="C√≥d" class="w-16 border rounded p-1 text-center font-bold text-sm"><input type="text" id="new-defect-desc" placeholder="Nova Descri√ß√£o" class="flex-grow border rounded p-1 text-sm"><button onclick="window.addDefect()" class="bg-green-600 text-white font-bold px-3 rounded">+</button></div>
                    <div class="defect-list-container mt-4">${generateDefectListHTML()}</div>
                </div>
            </div>`;

        const generateSubColumnHTML = (oven, row, type, dataArray) => dataArray.map((item, i) => `
            <div class="sub-row">
                <input type="text" id="input-${oven}-${row}-${type}-${i}-cod" class="input-cod" placeholder="Cd" value="${item.cod || ''}" oninput="window.updateSubStruct('${oven}', ${row}, '${type}', ${i}, 'cod', this.value)">
                <input type="text" id="input-${oven}-${row}-${type}-${i}-desc" class="${item.cod === '99' ? 'input-desc input-desc-editable' : 'input-desc'}" ${item.cod === '99' ? '' : 'readonly'} value="${item.desc || ''}" tabindex="-1" oninput="window.updateSubStruct('${oven}', ${row}, '${type}', ${i}, 'desc', this.value)">
                <input type="text" id="input-${oven}-${row}-${type}-${i}-val" class="input-val" placeholder="%" inputmode="decimal" value="${item.val || ''}" oninput="window.updateSubStruct('${oven}', ${row}, '${type}', ${i}, 'val', this.value)">
            </div>`).join('');

        const generateClosingRow = (ovenName, closingIndex, data) => {
            const cd = data.closing && data.closing[closingIndex] ? data.closing[closingIndex] : { prod: '', quebra: '' };
            return `<tr class="bg-gray-dark-custom h-8 border-t border-b border-black"><td colspan="6" class="font-bold text-sm align-middle border-r border-black">Fechamento do Turno</td><td class="border-r border-black p-0"><div class="flex justify-between items-center px-2 h-full"><span class="text-[0.65rem] font-bold mr-1">Vol Produ√ß√£o</span><div class="flex bg-white/50 rounded px-1"><input type="text" inputmode="decimal" class="w-20 text-right font-bold text-xs bg-transparent" value="${cd.prod || ''}" oninput="window.syncClosing('${ovenName}', ${closingIndex}, 'prod', this.value)"><span class="text-[0.6rem] font-bold ml-1">m¬≤</span></div></div></td><td class="p-0"><div class="flex justify-between items-center px-2 h-full"><span class="text-[0.65rem] font-bold mr-1">Vol Quebra</span><div class="flex bg-white/50 rounded px-1"><input type="text" inputmode="decimal" class="w-20 text-right font-bold text-xs bg-transparent" value="${cd.quebra || ''}" oninput="window.syncClosing('${ovenName}', ${closingIndex}, 'quebra', this.value)"><span class="text-[0.6rem] font-bold ml-1">m¬≤</span></div></div></td></tr>`;
        };

        const generateOvenHTML = (ovenName) => {
            const data = ovenDataStore[ovenName];
            const safeOven = ovenName.replace(/\s+/g, '-');
            let rowsHTML = '';
            const currentSchedule = (ovenName.includes('RET√çFICA')) ? scheduleGrinders : scheduleOvens;

            currentSchedule.forEach((item, index) => {
                const rowData = data.rows[index];
                const rowBg = index % 2 !== 0 ? 'bg-gray-custom' : '';
                let refClasses = "nav-input ref-input";
                if (ovenName.includes('RET√çFICA') && rowData.ref === "EQUIPAMENTO PARADO") refClasses += " text-stop-alert";
                else if (rowData.ref === "‚ùåFORNO PARADO‚ö†Ô∏è") refClasses += " text-red-600 font-black";

                rowsHTML += `
                    <tr class="${rowBg}" data-oven="${ovenName}" data-row="${index}">
                        <td class="font-bold border-black text-sm p-0">${item.time}<span class="shift-stamp">${item.shift}</span></td>
                        <td class="border-black"><input type="text" id="input-${safeOven}-${index}-ref" class="${refClasses}" list="ref-suggestions" value="${rowData.ref || ''}" oninput="window.syncData('${ovenName}', ${index}, 'ref', this.value); window.sugerirReferencia(this, '${ovenName}')"></td>
                        <td class="border-black"><select id="select-${safeOven}-${index}-turno" class="text-gray-700 font-medium nav-input" onchange="window.syncData('${ovenName}', ${index}, 'turno', this.value)"><option value="" ${rowData.turno === '' ? 'selected' : ''}>-</option><option value="A" ${rowData.turno === 'A' ? 'selected' : ''}>A</option><option value="B" ${rowData.turno === 'B' ? 'selected' : ''}>B</option><option value="C" ${rowData.turno === 'C' ? 'selected' : ''}>C</option><option value="A/B" ${rowData.turno === 'A/B' ? 'selected' : ''}>A/B</option><option value="B/C" ${rowData.turno === 'B/C' ? 'selected' : ''}>B/C</option><option value="C/A" ${rowData.turno === 'C/A' ? 'selected' : ''}>C/A</option></select></td>
                        <td class="border-black"><input type="text" inputmode="decimal" id="input-${safeOven}-${index}-vol" class="nav-input" value="${rowData.vol || ''}" oninput="window.syncData('${ovenName}', ${index}, 'vol', this.value); window.runCalcs('${ovenName}')"></td>
                        <td class="border-black"><input type="text" inputmode="decimal" id="input-${safeOven}-${index}-qHora" class="input-quali-hora nav-input" value="${rowData.qHora || ''}" oninput="window.syncData('${ovenName}', ${index}, 'qHora', this.value); window.runCalcs('${ovenName}')"></td>
                        <td class="border-black"><input type="text" id="input-${safeOven}-${index}-qAcum" class="input-quali-acum" readonly placeholder="0.00"></td>
                        <td class="border-black p-0 w-[150px]"><div class="flex flex-col">${generateSubColumnHTML(ovenName, index, 'defects', rowData.defects)}</div></td>
                        <td class="border-black p-0 w-[200px]"><div class="flex h-full"><div class="flex flex-col flex-grow">${generateSubColumnHTML(ovenName, index, 'quebras', rowData.quebras)}</div><div class="quebra-total-box"><div class="quebra-total-header uppercase">Total</div><div class="flex-grow flex items-center justify-center font-bold text-xs" id="total-${ovenName}-${index}">0,00</div></div></div></td>
                    </tr>`;
                if (index === 3 || index === 7 || index === 11) rowsHTML += generateClosingRow(ovenName, index === 3 ? 0 : index === 7 ? 1 : 2, data);
            });

            return `
                <div class="bg-white shadow-lg border-t border-black rounded-b-lg overflow-hidden">
                    <!-- CABE√áALHO SIM√âTRICO COM IDENTIDADE VISUAL -->
                    <div class="flex justify-between items-center bg-gray-50 border-b border-black px-4 py-2">
                        <!-- Logo Esquerda: Mohawk Brasil -->
                        <div class="flex flex-col items-center justify-center select-none w-[100px]" aria-label="Logo Mohawk Brasil">
                            <span class="text-gray-800 font-black tracking-tighter" style="font-family: Georgia, 'Times New Roman', Times, serif; font-size: 1.15rem; line-height: 0.85;">MOHAWK</span>
                            <span class="text-red-700 font-bold tracking-[0.4em] ml-[0.4em]" style="font-family: Arial, Helvetica, sans-serif; font-size: 0.45rem; line-height: 1; margin-top: 3px;">BRASIL</span>
                        </div>
                        
                        <!-- T√≠tulo Central -->
                        <div class="text-xl font-bold uppercase text-gray-800 tracking-wide text-center flex-grow">
                            Acompanhamento - ${ovenName}
                        </div>
                        
                        <!-- Logo Direita: SC 2 -->
                        <div class="flex flex-col items-center justify-center select-none w-[100px]" aria-label="Unidade SC 2">
                            <span class="text-gray-800 font-black tracking-tighter" style="font-family: Georgia, 'Times New Roman', Times, serif; font-size: 1.15rem; line-height: 0.85;">SC</span>
                            <span class="text-red-700 font-bold tracking-[0.4em] ml-[0.4em]" style="font-family: Arial, Helvetica, sans-serif; font-size: 0.85rem; line-height: 1; margin-top: 2px;">2</span>
                        </div>
                    </div>
                    
                    <div class="flex border-b border-black font-bold uppercase text-[0.6rem] bg-white">
                        <div class="w-1/2 border-r border-black p-1 flex justify-center items-center">${ovenName}</div>
                        <div class="w-1/2 p-1 flex justify-center items-center gap-1">
                            <span>Linha:</span>
                            <select onchange="window.syncLinha('${ovenName}', this.value)" class="border border-gray-300 rounded px-1 font-normal text-red-600 h-5 w-12"><option value="">-</option><option value="1" ${data.linha === '1' ? 'selected' : ''}>1</option><option value="2" ${data.linha === '2' ? 'selected' : ''}>2</option><option value="4" ${data.linha === '4' ? 'selected' : ''}>4</option><option value="5" ${data.linha === '5' ? 'selected' : ''}>5</option><option value="6" ${data.linha === '6' ? 'selected' : ''}>6</option></select>
                        </div>
                    </div>
                    
                    <!-- Wrapper para scroll horizontal em telas menores -->
                    <div class="table-responsive-wrapper">
                        <table class="w-full min-w-[900px]"> <!-- min-w impede esmagamento das colunas no celular -->
                            <thead>
                                <tr class="header-blue font-bold text-xs leading-tight bg-gray-50">
                                    <th class="w-14">Hora</th><th class="w-48">Refer√™ncia</th><th class="w-12">Turno</th><th class="w-20">Volume</th><th class="w-24">Qualidade Hora (%)</th><th class="w-24">Qualidade Acumulada (%)</th>
                                    <th class="w-[150px] p-0"><div class="text-center border-b border-black">Defeitos</div><div class="sub-header-row"><span class="sh-cod text-center">C√≥d</span><span class="sh-desc text-center">Descri√ß√£o</span><span class="sh-val text-center">%</span></div></th>
                                    <th class="w-[200px] text-red-600 p-0"><div class="text-center border-b border-black">Quebra</div><div class="flex"><div class="flex-grow"><div class="sub-header-row" style="border-bottom:none;"><span class="sh-cod text-center">C√≥d</span><span class="sh-desc text-center">Descri√ß√£o</span><span class="sh-val text-center">%</span></div></div><div class="w-[50px] border-l border-black flex items-center justify-center bg-gray-200 cursor-pointer hover:bg-gray-300 search-trigger" onclick="window.toggleDefectList('${ovenName}')" title="Lista de Defeitos">üîç</div></div></th>
                                </tr>
                            </thead>
                            <tbody>${rowsHTML}</tbody>
                        </table>
                    </div>
                </div>`;
        };
        
        const renderContent = () => {
            const activeElement = document.activeElement;
            let focusedId = null, cursorStart = null, cursorEnd = null;
            if (activeElement && activeElement.tagName === 'INPUT') { focusedId = activeElement.id; try { cursorStart = activeElement.selectionStart; cursorEnd = activeElement.selectionEnd; } catch(e){} }

            const mainContent = document.getElementById('main-content');
            if (!isDataLoaded) { mainContent.style.opacity = '0.5'; mainContent.style.pointerEvents = 'none'; } 
            else { mainContent.style.opacity = '1'; mainContent.style.pointerEvents = 'auto'; }

            if (viewMode === 'config') mainContent.innerHTML = generateConfigHTML();
            else {
                // Modo Exibi√ß√£o de Tabela √önica
                mainContent.innerHTML = generateOvenHTML(currentOven);
                window.attachCalculations(currentOven);
            }

            if (focusedId && isDataLoaded) {
                const el = document.getElementById(focusedId);
                if(el) { el.focus(); try{el.setSelectionRange(cursorStart, cursorEnd)}catch(e){} }
            }
        };

        const init = async () => {
            if (window.location.protocol === 'file:') { document.getElementById('version-blocker').style.display = 'flex'; return; }
            resetStore(); updateDateUI(); renderContent();
            
            // Rel√≥gio Interno Robusto: Verifica a cada minuto para Backup e Mudan√ßa de Dia
            setInterval(() => {
                const now = new Date();
                
                // 1. Virada de Meia-Noite (Mudan√ßa de Dia)
                if (now.getDate() !== lastKnownDay) { 
                    const oldDate = new Date(selectedDate);
                    lastKnownDay = now.getDate(); 
                    selectedDate = now; 
                    updateDateUI(); // Atualiza a data visual na tela de imediato
                    
                    // For√ßa um √∫ltimo backup fotogr√°fico do dia que acabou (modo silencioso)
                    if (isDataLoaded && db) {
                        window.runManualBackup(oldDate, true); 
                    }
                    
                    window.setupRealtimeListener(); 
                    lastBackupHour = now.getHours(); // Reseta para evitar disparo duplo de hora
                    return;
                }

                // 2. Backup de Hora em Hora (Sincronizado na virada do rel√≥gio, ex: 01:00, 02:00)
                if (now.getHours() !== lastBackupHour) {
                    lastBackupHour = now.getHours();
                    if (isDataLoaded && db) {
                        window.runManualBackup(null, true); // (null = data atual, true = sem alert)
                    }
                }
            }, 60000);

            if(auth) {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                } catch (e) {}
                onAuthStateChanged(auth, async user => { if(user) { await loadGlobalConfig(); setupDefectsListener(); window.setupRealtimeListener(); } });
            }

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    if (document.activeElement.id === 'admin-password' || document.activeElement.id === 'defect-search') return;
                    e.preventDefault();
                    const el = document.activeElement; if (!el || (el.tagName !== 'INPUT' && el.tagName !== 'SELECT')) return;
                    const subMatch = el.id.match(/input-(.+)-(\d+)-(defects|quebras)-(\d+)-(cod|val|desc)/);
                    if (subMatch) {
                        const [_, oven, rowStr, type, idxStr, field] = subMatch; const row = parseInt(rowStr), idx = parseInt(idxStr);
                        if (field === 'cod') {
                            const descInput = document.getElementById(`input-${oven}-${row}-${type}-${idx}-desc`);
                            if (descInput && !descInput.hasAttribute('readonly')) descInput.focus(); else document.getElementById(`input-${oven}-${row}-${type}-${idx}-val`)?.focus();
                        } else if (field === 'desc') document.getElementById(`input-${oven}-${row}-${type}-${idx}-val`)?.focus();
                        else if (field === 'val') {
                            if (idx < 3) document.getElementById(`input-${oven}-${row}-${type}-${idx+1}-cod`)?.focus();
                            else {
                                if (type === 'defects') document.getElementById(`input-${oven}-${row}-quebras-0-cod`)?.focus();
                                else if (row < 11) document.getElementById(`input-${oven.replace(/\s+/g, '-')}-${row+1}-ref`)?.focus();
                            }
                        }
                        return;
                    }
                    const inputs = Array.from(document.querySelectorAll('input, select'));
                    const currentIdx = inputs.indexOf(el); if (currentIdx >= 0 && currentIdx < inputs.length - 1) inputs[currentIdx + 1].focus();
                }
            });
        };

        init();
    </script>
</body>
</html>
